# Approov Token Binding Quickstart

This quickstart is for developers familiar with NodeJS who are looking for a quick intro into how they can add [Approov](https://approov.io) into an existing project. Therefore this will guide you through the necessary steps for adding Approov with token binding to an existing NodeJS Express API server.

## TOC - Table of Contents

* [Why?](#why)
* [How it Works?](#how-it-works)
* [Requirements](#requirements)
* [Approov Setup](#approov-setup)
* [Approov Token Check](#approov-token-binding-check)
* [Test your Approov Integration](#test-your-approov-integration)


## Why?

To lock down your API server to your mobile app. Please read the brief summary in the [README](/README.md#why) at the root of this repo or visit our [website](https://approov.io/product.html) for more details.

[TOC](#toc---table-of-contents)


## How it works?

For more background, see the overview in the [README](/README.md#how-it-works) at the root of this repository.

The main functionality for the Approov token binding check is in the file [/servers/hello/src/approov-protected-server/token-binding-check/hello_server_protected.js](/servers/hello/src/approov-protected-server/token-binding-check/hello_server_protected.js). Take a look at the `_verifyApproovToken()` and `_erifyApproovTokenBinding()` functions to see the simple code for the checks.

[TOC](#toc---table-of-contents)


## Requirements

To complete this quickstart you will need both NodeJS and the Approov CLI tool installed.

* [NodeJS](https://nodejs.org/en/download/)
* [Approov CLI](https://approov.io/docs/latest/approov-installation/#approov-tool) - Learn how to use it [here](https://approov.io/docs/latest/approov-cli-tool-reference/)

[TOC](#toc---table-of-contents)


## Approov Setup

To use Approov with the NodeJS Express API server we need a small amount of configuration. First, Approov needs to know the API domain that will be protected. Second, the NodeJS Express API server needs the Approov Base64 encoded secret that will be used to verify the tokens generated by the Approov cloud service.

### Configure API Domain

Approov needs to know the domain name of the API for which it will issue tokens.

Add it with:

```bash
approov api -add your.api.domain.com
```

Adding the API domain also configures the [dynamic certificate pinning](https://approov.io/docs/latest/approov-usage-documentation/#approov-dynamic-pinning) setup, out of the box.

> **NOTE:** By default the pin is extracted from the public key of the leaf certificate served by the domain, as visible to the box issuing the Approov CLI command and the Approov servers.

### Approov Secret

Approov tokens are signed with a symmetric secret. To verify tokens, we need to grab the secret using the [Approov secret command](https://approov.io/docs/latest/approov-cli-tool-reference/#secret-command) and plug it into the NodeJS Express API server environment to check the signatures of the [Approov Tokens](https://www.approov.io/docs/latest/approov-usage-documentation/#approov-tokens) that it processes.

First, enable your Approov `admin` role with:

```bash
eval `approov role admin`
```

Next, retrieve the Approov secret with:

```bash
approov secret -get base64
```

> **NOTE:** The `approov secret` command requires an [administration role](https://approov.io/docs/latest/approov-usage-documentation/#account-access-roles) to execute successfully.

#### Set the Approov Secret

Open the `.env` file and add the Approov secret to the var:

```bash
APPROOV_BASE64_SECRET=approov_base64_secret_here
```

[TOC](#toc---table-of-contents)


## Approov Token Check

To check the Approov token we will use the [auth0/express-jwt](https://github.com/auth0/express-jwt) package, but you are free to use another one of your preference.

Below is [this working server](/servers/hello/src/approov-protected-server/token-binding-check) with the Approov token check. Add to your project the code from the sections `DEPENDENCIES`, `LOAD ENV VARS`, `APPROOV CALLBACKS`, `MIDDLEWARE` and `HELPERS`.

```javascript
const debug = require('debug')('hello-server')
const express = require('express')
const cors = require('cors')
const api = express()
api.use(cors())


//////////////////
// DEPENDENCIES
//////////////////

const dotenv = require('dotenv').config()
const jwt = require('express-jwt')
const crypto = require('crypto')


///////////////////
// LOAD ENV VARS
///////////////////

if (dotenv.error) {
  throw new Error('LOAD ENV VARS: ' + dotenv.error)
}

if (! "APPROOV_BASE64_SECRET" in dotenv.parsed) {
  throw new Error("LOAD ENV VARS: Failed to load APPROOV_BASE64_SECRET. Check it's set in the .env file")
}

const APPROOV_SECRET = Buffer.from(dotenv.parsed.APPROOV_BASE64_SECRET, 'base64')


///////////////////////
// APPROOV CALLBACKS
///////////////////////

// Callback that performs the Approov token check using the express-jwt library
const verifyApproovToken = jwt({
  secret: APPROOV_SECRET,
  requestProperty: 'approovTokenDecoded',
  getToken: function fromApproovTokenHeader(req, res) {
    return req.get('Approov-Token')
  },
  algorithms: ['HS256']
})

// Callback to handle the errors occurred while checking the Approov token.
const approovTokenErrorHandler = (err, req, res, next) => {
  // When has an error, it means the header `Approov-Token` is empty, missing or
  // have failed validation of signature, expire time or is malformed.
  // @see verifyApproovToken()
  if (err.name === 'UnauthorizedError') {
    // You may want to enable logging here...
    // debug("---> Approov token error -> " + err)
    res.status(401)
    res.json({})
    return
  }

  next()
}

// Callback to check the Approov token binding in the header matches with the
// one in the key `pay` of the Approov token claims.
const verifyApproovTokenBinding = (req, res, next) => {

  // The decoded Approov token was added to the request object when the checked
  // it at `verifyApproovToken()`
  token_binding_payload = req.approovTokenDecoded.pay

  if (token_binding_payload === undefined) {
    // You may want to enable logging here...
    // debug("---> Approov token binding error -> key 'pay' is missing in the claims of the Approov token payload.")
    res.status(401)
    res.json({})
    return
  }

  if (isEmptyString(token_binding_payload)) {
      // You may want to enable logging here...
      // debug("---> Approov token binding error -> key 'pay' in the decoded token is empty.")
      res.status(401)
      res.json({})
      return
  }

  // We use here the Authorization token, but feel free to use another header,
  // but you need to bind this header to the Approov token in the mobile app.
  const token_binding_header = req.get('Authorization')

  if (isEmptyString(token_binding_header)) {
      // You may want to enable logging here...
      // debug("---> Approov token binding error -> Missing or empty header to perform the verification for the token binding.")
      res.status(401)
      res.json({})
      return
  }

  // We need to hash and base64 encode the token binding header, because that's
  // how it was included in the Approov token payload claim.
  const token_binding_header_encoded = crypto.createHash('sha256').update(token_binding_header, 'utf-8').digest('base64')

  if (token_binding_payload !== token_binding_header_encoded) {
      // You may want to enable logging here...
      // debug("---> Approov token error -> token binding in header doesn't match with the key 'pay' in the decoded token.")
      res.status(401)
      res.json({})
      return
  }

  // Let the request continue as usual.
  next()
}


////////////////
// MIDDLEWARE
////////////////

api.use(logRequest)

// Middleware to handle the validation of the Approov token.
api.use(verifyApproovToken)
api.use(approovTokenErrorHandler)
api.use(verifyApproovTokenBinding)


////////////////
// ENDPOINTS
////////////////

// simple 'hello world' endpoint.
api.get('/', function (req, res, next) {
  res.json({
    message: "Your API endpoints...",
  })
})


////////////
// SERVER
////////////

// Create and run the HTTP server
api.listen(8002, function () {
  debug("Server listening on %s", "localhost")
})


/////////////
// HELPERS
/////////////

const isEmpty = function(value) {
  return  (value === undefined) || (value === null) || (value === '')
}

const isString = function(value) {
  return (typeof(value) === 'string')
}

const isEmptyString = function(value) {
  return (isEmpty(value) === true) || (isString(value) === false) ||  (value.trim() === '')
}

```

> **NOTE:** When the Approov token validation fails we return a `401` with an empty body, because we don't want to give clues to an attacker about the reason the request failed, and you can go even further by returning a `400`.

A full working example for a simple Hello World server can be found at [/servers/hello/src/approov-protected-server/token-binding-check](/servers/hello/src/approov-protected-server/token-binding-check).

[TOC](#toc---table-of-contents)


## Test your Approov Integration

The following examples below use cURL, but you can also use the [Postman Collection](/README.md#testing-with-postman) to make the API requests. Just remember that you need to adjust the urls and tokens defined in the collection to match your deployment. Alternatively, the above README also contains instructions for using the preset _dummy_ secret to test your Approov integration.

#### With Valid Approov Tokens

Generate a valid token example from the Approov Cloud service:

```bash
approov token -setDataHashInToken 'Bearer authorizationtoken' -genExample your.api.domain.com
```

Then make the request with the generated token:

```bash
curl -i --request GET 'https://your.api.domain.com/v1/shapes' \
  --header 'Authorization: Bearer authorizationtoken' \
  --header 'Approov-Token: APPROOV_TOKEN_EXAMPLE_HERE'
```

The request should be accepted. For example:

```text
HTTP/1.1 200 OK

...

{"message": "Hello, World!"}
```

#### With Invalid Approov Tokens

##### No Authorization Token

Let's just remove the Authorization header from the request:

```bash
curl -i --request GET 'https://your.api.domain.com/v1/shapes' \
  --header 'Approov-Token: APPROOV_TOKEN_EXAMPLE_HERE'
```

The above request should fail with an Unauthorized error. For example:

```text
HTTP/1.1 401 Unauthorized

...

{}
```

##### Same Approov Token with a Different Authorization Token

Make the request with the same generated token, but with another random authorization token:

```bash
curl -i --request GET 'https://your.api.domain.com/v1/shapes' \
  --header 'Authorization: Bearer anotherauthorizationtoken' \
  --header 'Approov-Token: APPROOV_TOKEN_EXAMPLE_HERE'
```

The above request should also fail with an Unauthorized error. For example:

```text
HTTP/1.1 401 Unauthorized

...

{}
```

[TOC](#toc---table-of-contents)


## Issues

If you find any issue while following our instructions then just report it [here](https://github.com/approov/quickstart-nodejs-express-token-check/issues), with the steps to reproduce it, and we will sort it out and/or guide you to the correct path.

[TOC](#toc---table-of-contents)


## Useful Links

If you wish to explore the Approov solution in more depth, then why not try one of the following links as a jumping off point:

* [Approov Free Trial](https://approov.io/signup)(no credit card needed)
* [Approov Get Started](https://approov.io/product/demo)
* [Approov QuickStarts](https://approov.io/docs/latest/approov-integration-examples/)
* [Approov Docs](https://approov.io/docs)
* [Approov Blog](https://approov.io/blog/)
* [Approov Resources](https://approov.io/resource/)
* [Approov Customer Stories](https://approov.io/customer)
* [Approov Support](https://approov.zendesk.com/hc/en-gb/requests/new)
* [About Us](https://approov.io/company)
* [Contact Us](https://approov.io/contact)

[TOC](#toc---table-of-contents)
